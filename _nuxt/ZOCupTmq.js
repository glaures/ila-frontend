import{e as ae,i as ne,j as ie,g as oe,r as m,k as U,m as de,n as re,c as a,a as s,p as _,d as c,t as o,F as x,s as I,C as z,q as ce,v as ue,o as n,B as L,M as be,_ as me}from"./C40gEiOu.js";import{u as ve}from"./MOukZuHn.js";import{w as ge}from"./BA3RTNws.js";const he={class:"exchange-page"},pe={class:"container py-4"},fe={class:"d-flex justify-content-between align-items-center mb-4"},ye={key:0,class:"text-muted mb-0"},_e={key:0,class:"text-success"},we={key:1,class:"text-warning"},ke={key:2,class:"text-secondary"},xe={class:"badge bg-primary fs-6"},De={key:0,class:"text-center py-5"},Ce={class:"card mb-4 shadow-sm"},Ie={class:"card-body p-0"},Le={class:"table-responsive"},Ne={class:"table table-hover mb-0"},We={class:"fw-medium"},Ee={class:"text-end"},Se=["onClick","disabled"],Re={key:1,class:"badge bg-secondary"},Fe={key:0,class:"card mb-4 shadow-sm"},Ae={class:"card-header bg-white d-flex justify-content-between align-items-center"},Pe={class:"badge bg-info"},$e={class:"card-body p-0"},Te={class:"list-group list-group-flush"},Ke={class:"d-flex justify-content-between align-items-start"},Ue={class:"flex-grow-1"},ze={class:"d-flex align-items-center mb-2"},Be={class:"fw-medium me-2"},je={class:"text-primary"},Me={class:"small"},Oe={class:"mb-0 ps-3"},Ve={class:"text-end"},Ye={key:0},Ge=["onClick"],Ze=["onClick"],He={key:1,class:"small text-success"},Xe={key:2,class:"small text-danger"},Je={class:"modal-dialog modal-lg modal-dialog-scrollable"},Qe={class:"modal-content"},qe={class:"modal-body"},es={key:0,class:"alert alert-light border mb-4"},ss={class:"fw-medium"},ts={class:"badge bg-secondary ms-2"},ls={class:"mb-3"},as={key:0,class:"text-center text-muted py-4"},ns=["onDragstart","onDrop"],is={class:"badge bg-primary me-2"},os={class:"flex-grow-1"},ds={class:"fw-medium"},rs={class:"small text-muted"},cs={class:"text-end me-2"},us=["onClick"],bs={class:"input-group mb-3"},ms={class:"available-courses-list",style:{"max-height":"300px","overflow-y":"auto"}},vs=["draggable","onDragstart"],gs={class:"flex-grow-1"},hs={class:"fw-medium"},ps={class:"small text-muted"},fs={key:0,class:"small text-danger"},ys={key:1,class:"small text-warning"},_s={class:"text-end"},ws=["onClick"],ks={key:1,class:"badge bg-info ms-2"},xs={class:"modal-footer"},Ds=["disabled"],Cs={key:0,class:"spinner-border spinner-border-sm me-2"},Is={key:1,class:"bi bi-check-lg me-1"},Ls=ae({__name:"wechselwunsch",setup(Ns){const{$authFetch:h}=ne(),F=ve(),A=ie(),w=oe(),b=m(null),N=m(!0),f=m(null),P=m([]),W=m([]),E=m([]),y=m(null),r=m([]),k=m(""),S=m(!1),D=m(null),$=m(null);let v=null;const B=U(()=>W.value.filter(l=>l.status==="PENDING").length),j=U(()=>{let l=E.value;if(k.value){const e=k.value.toLowerCase();l=l.filter(i=>i.name.toLowerCase().includes(e)||i.blockName.toLowerCase().includes(e))}return l}),R=async()=>{var l;N.value=!0;try{if(!b.value)if(F.currentPeriod)b.value=F.currentPeriod;else{const u=(await h("/periods")).find(K=>K.current);u&&(b.value=u)}if(!b.value){console.warn("Keine aktuelle Periode verfügbar"),N.value=!1;return}const e=await h(`/periods/${b.value.id}/exchange-phase`);f.value=e;const i=await h(`/assignments/my?periodId=${b.value.id}`);P.value=i;const t=await h(`/exchange/my-requests?periodId=${b.value.id}`);W.value=t}catch(e){w.show(((l=e==null?void 0:e.data)==null?void 0:l.message)??"Fehler beim Laden der Daten")}finally{N.value=!1}},M=l=>{var e;return!l.preset&&((e=f.value)==null?void 0:e.active)},O=async l=>{var e;if(y.value=l,r.value=[],D.value=null,k.value="",!b.value){w.show("Keine aktuelle Periode verfügbar");return}try{const i=await h(`/exchange/available-courses?periodId=${b.value.id}&assignmentId=${l.id}`);E.value=i}catch(i){w.show(((e=i==null?void 0:i.data)==null?void 0:e.message)??"Fehler beim Laden der verfügbaren Kurse");return}$.value&&!v&&(v=new be($.value)),v==null||v.show()},V=async l=>{var i,t;const e=P.value.find(d=>d.course.name===l.currentCourseName);if(e){y.value=e,D.value=l,k.value="";try{const d=await h(`/exchange/available-courses?periodId=${(i=b.value)==null?void 0:i.id}&assignmentId=${e.id}`);E.value=d,r.value=l.desiredCourses.map(u=>E.value.find(le=>le.id===u.id)||{id:u.id,courseId:u.courseId,name:u.name,blockName:u.blockName,blockId:0,dayOfWeek:"",availableSpots:0,eligible:!0,ineligibilityReason:null})}catch(d){w.show(((t=d==null?void 0:d.data)==null?void 0:t.message)??"Fehler beim Laden der verfügbaren Kurse");return}v==null||v.show()}},Y=async l=>{var e;if(confirm("Möchtest du diesen Wechselwunsch wirklich zurückziehen?"))try{await h(`/exchange/${l.id}`,{method:"DELETE"}),A.success("Wechselwunsch zurückgezogen"),await R()}catch(i){w.show(((e=i==null?void 0:i.data)==null?void 0:e.message)??"Fehler beim Zurückziehen")}},G=l=>{C(l)||r.value.push(l)},Z=l=>{r.value.splice(l,1)},C=l=>r.value.some(e=>e.id===l.id);let g=null,p=null;const H=(l,e)=>{var i;g=e,p=null,(i=l.dataTransfer)==null||i.setData("text/plain",e.id.toString())},X=(l,e)=>{var i;g=r.value[e],p=e,(i=l.dataTransfer)==null||i.setData("text/plain",e.toString())},J=l=>{g&&p===null&&!C(g)&&r.value.push(g),g=null,p=null},Q=(l,e)=>{if(p!==null&&p!==e){const i=r.value.splice(p,1)[0];r.value.splice(e,0,i)}else g&&p===null&&!C(g)&&r.value.splice(e,0,g);g=null,p=null},q=async()=>{var l;if(!(!y.value||r.value.length===0||!b.value)){S.value=!0;try{const e=r.value.map(i=>i.id);D.value?(await h(`/exchange/${D.value.id}`,{method:"PUT",body:{desiredCourseIds:e}}),A.success("Wechselwunsch aktualisiert")):(await h("/exchange",{method:"POST",body:{periodId:b.value.id,currentAssignmentId:y.value.id,desiredCourseIds:e}}),A.success("Wechselwunsch abgegeben")),v==null||v.hide(),await R()}catch(e){w.show(((l=e==null?void 0:e.data)==null?void 0:l.message)??"Fehler beim Absenden des Wechselwunsches")}finally{S.value=!1}}},T=l=>ge[l]||l,ee=l=>({MONDAY:"bg-primary",TUESDAY:"bg-success",WEDNESDAY:"bg-warning text-dark",THURSDAY:"bg-info",FRIDAY:"bg-danger"})[l]||"bg-secondary",se=l=>({PENDING:"bg-warning text-dark",FULFILLED:"bg-success",UNFULFILLABLE:"bg-danger",EXPIRED:"bg-secondary",WITHDRAWN:"bg-light text-dark"})[l]||"bg-secondary",te=l=>({PENDING:"Offen",FULFILLED:"Erfüllt",UNFULFILLABLE:"Nicht möglich",EXPIRED:"Abgelaufen",WITHDRAWN:"Zurückgezogen"})[l]||l;return de(()=>{R()}),re(()=>F.currentPeriod,()=>{R()}),(l,e)=>{var i;return n(),a("div",he,[s("div",pe,[s("div",fe,[s("div",null,[e[6]||(e[6]=s("h1",{class:"h3 mb-1"},"Kurswechsel",-1)),f.value?(n(),a("p",ye,[f.value.active?(n(),a("span",_e,[e[3]||(e[3]=s("i",{class:"bi bi-circle-fill me-1",style:{"font-size":"0.5rem"}},null,-1)),c(" Wechselphase aktiv bis "+o(f.value.end),1)])):f.value.upcoming?(n(),a("span",we,[e[4]||(e[4]=s("i",{class:"bi bi-clock me-1"},null,-1)),c(" Startet am "+o(f.value.start),1)])):(n(),a("span",ke,e[5]||(e[5]=[s("i",{class:"bi bi-x-circle me-1"},null,-1),c(" Wechselphase beendet ")])))])):_("",!0)]),s("div",null,[s("span",xe,o((i=b.value)==null?void 0:i.name),1)])]),N.value?(n(),a("div",De,e[7]||(e[7]=[s("div",{class:"spinner-border text-primary",role:"status"},[s("span",{class:"visually-hidden"},"Laden...")],-1),s("p",{class:"mt-3 text-muted"},"Lade Kursdaten...",-1)]))):(n(),a(x,{key:1},[s("div",Ce,[e[10]||(e[10]=s("div",{class:"card-header bg-white"},[s("h5",{class:"mb-0"},[s("i",{class:"bi bi-journal-bookmark me-2"}),c(" Meine aktuellen Kurse ")])],-1)),s("div",Ie,[s("div",Le,[s("table",Ne,[e[9]||(e[9]=s("thead",{class:"table-light"},[s("tr",null,[s("th",null,"Block"),s("th",null,"Kurs"),s("th",{class:"text-end"},"Aktion")])],-1)),s("tbody",null,[(n(!0),a(x,null,I(P.value,t=>{var d;return n(),a("tr",{key:t.id},[s("td",null,[s("span",{class:L(["badge",ee(t.block.dayOfWeek)])},o(t.block.name),3)]),s("td",We,o(t.course.name),1),s("td",Ee,[M(t)?(n(),a("button",{key:0,class:"btn btn-outline-primary btn-sm",onClick:u=>O(t),disabled:!((d=f.value)!=null&&d.active)},e[8]||(e[8]=[s("i",{class:"bi bi-arrow-left-right me-1"},null,-1),c(" Wechseln ")]),8,Se)):(n(),a("span",Re,o(t.preset?"Fest zugewiesen":"Nicht wechselbar"),1))])])}),128))])])])])]),W.value.length>0?(n(),a("div",Fe,[s("div",Ae,[e[11]||(e[11]=s("h5",{class:"mb-0"},[s("i",{class:"bi bi-hourglass-split me-2"}),c(" Meine Wechselwünsche ")],-1)),s("span",Pe,o(B.value)+" offen",1)]),s("div",$e,[s("div",Te,[(n(!0),a(x,null,I(W.value,t=>(n(),a("div",{key:t.id,class:"list-group-item"},[s("div",Ke,[s("div",Ue,[s("div",ze,[s("span",Be,o(t.currentCourseName),1),e[12]||(e[12]=s("i",{class:"bi bi-arrow-right mx-2 text-muted"},null,-1)),s("span",je,o(t.desiredCourses.length)+" Wunschkurs(e)",1)]),s("div",Me,[s("ol",Oe,[(n(!0),a(x,null,I(t.desiredCourses,d=>(n(),a("li",{key:d.id,class:"text-muted"},o(d.name)+" ("+o(d.blockName)+") ",1))),128))])])]),s("div",Ve,[s("span",{class:L(["badge mb-2 d-block",se(t.status)])},o(te(t.status)),3),t.status==="PENDING"?(n(),a("div",Ye,[s("button",{class:"btn btn-outline-secondary btn-sm me-1",onClick:d=>V(t)},e[13]||(e[13]=[s("i",{class:"bi bi-pencil"},null,-1)]),8,Ge),s("button",{class:"btn btn-outline-danger btn-sm",onClick:d=>Y(t)},e[14]||(e[14]=[s("i",{class:"bi bi-x-lg"},null,-1)]),8,Ze)])):t.status==="FULFILLED"?(n(),a("div",He,[e[15]||(e[15]=s("i",{class:"bi bi-check-circle me-1"},null,-1)),c(" "+o(t.fulfilledWithCourseName),1)])):t.rejectionReason?(n(),a("div",Xe,o(t.rejectionReason),1)):_("",!0)])])]))),128))])])])):_("",!0)],64)),s("div",{class:"modal fade",id:"exchangeModal",tabindex:"-1",ref_key:"exchangeModalRef",ref:$},[s("div",Je,[s("div",Qe,[e[27]||(e[27]=s("div",{class:"modal-header"},[s("h5",{class:"modal-title"},[s("i",{class:"bi bi-arrow-left-right me-2"}),c(" Kurs wechseln ")]),s("button",{type:"button",class:"btn-close","data-bs-dismiss":"modal"})],-1)),s("div",qe,[y.value?(n(),a("div",es,[e[16]||(e[16]=s("div",{class:"small text-muted mb-1"},"Du gibst ab:",-1)),s("div",ss,[c(o(y.value.course.name)+" ",1),s("span",ts,o(y.value.block.name),1)])])):_("",!0),s("div",ls,[e[19]||(e[19]=s("label",{class:"form-label fw-medium"},[s("i",{class:"bi bi-list-ol me-1"}),c(" Wunschliste (nach Priorität geordnet) ")],-1)),e[20]||(e[20]=s("p",{class:"small text-muted"}," Ziehe Kurse in deine Wunschliste. Die Reihenfolge bestimmt die Priorität. ",-1)),s("div",{class:"wishlist-container border rounded p-3 mb-3 bg-light",onDragover:e[1]||(e[1]=z(()=>{},["prevent"])),onDrop:J},[r.value.length===0?(n(),a("div",as,e[17]||(e[17]=[s("i",{class:"bi bi-arrow-down-circle fs-3 d-block mb-2"},null,-1),c(" Ziehe gewünschte Kurse hierher ")]))):_("",!0),(n(!0),a(x,null,I(r.value,(t,d)=>(n(),a("div",{key:t.id,class:"wishlist-item d-flex align-items-center bg-white border rounded p-2 mb-2",draggable:"true",onDragstart:u=>X(u,d),onDragover:e[0]||(e[0]=z(()=>{},["prevent"])),onDrop:u=>Q(u,d)},[s("span",is,o(d+1),1),s("div",os,[s("div",ds,o(t.name),1),s("div",rs,o(t.blockName)+" · "+o(T(t.dayOfWeek)),1)]),s("div",cs,[s("span",{class:L(["badge",t.availableSpots>0?"bg-success":"bg-danger"])},o(t.availableSpots)+" Plätze frei ",3)]),s("button",{class:"btn btn-outline-danger btn-sm",onClick:u=>Z(d)},e[18]||(e[18]=[s("i",{class:"bi bi-x"},null,-1)]),8,us)],40,ns))),128))],32)]),s("div",null,[e[25]||(e[25]=s("label",{class:"form-label fw-medium"},[s("i",{class:"bi bi-collection me-1"}),c(" Verfügbare Kurse ")],-1)),s("div",bs,[e[21]||(e[21]=s("span",{class:"input-group-text"},[s("i",{class:"bi bi-search"})],-1)),ce(s("input",{type:"text",class:"form-control",placeholder:"Kurse durchsuchen...","onUpdate:modelValue":e[2]||(e[2]=t=>k.value=t)},null,512),[[ue,k.value]])]),s("div",ms,[(n(!0),a(x,null,I(j.value,t=>(n(),a("div",{key:t.id,class:L(["available-course-item d-flex align-items-center border rounded p-2 mb-2",{"border-success":t.eligible&&!t.warning,"border-warning":t.eligible&&t.warning,"border-secondary opacity-50":!t.eligible,"cursor-grab":t.eligible}]),draggable:t.eligible,onDragstart:d=>H(d,t)},[s("div",gs,[s("div",hs,o(t.name),1),s("div",ps,o(t.blockName)+" · "+o(T(t.dayOfWeek)),1),t.eligible?t.warning?(n(),a("div",ys,[e[23]||(e[23]=s("i",{class:"bi bi-exclamation-triangle me-1"},null,-1)),c(" "+o(t.warning),1)])):_("",!0):(n(),a("div",fs,[e[22]||(e[22]=s("i",{class:"bi bi-exclamation-circle me-1"},null,-1)),c(" "+o(t.ineligibilityReason),1)]))]),s("div",_s,[s("span",{class:L(["badge",t.availableSpots>0?"bg-success":"bg-danger"])},o(t.availableSpots)+" frei ",3),t.eligible&&!C(t)?(n(),a("button",{key:0,class:"btn btn-outline-primary btn-sm ms-2",onClick:d=>G(t)},e[24]||(e[24]=[s("i",{class:"bi bi-plus"},null,-1)]),8,ws)):C(t)?(n(),a("span",ks," In Wunschliste ")):_("",!0)])],42,vs))),128))])])]),s("div",xs,[e[26]||(e[26]=s("button",{type:"button",class:"btn btn-secondary","data-bs-dismiss":"modal"}," Abbrechen ",-1)),s("button",{type:"button",class:"btn btn-primary",disabled:r.value.length===0||S.value,onClick:q},[S.value?(n(),a("span",Cs)):(n(),a("i",Is)),c(" "+o(D.value?"Aktualisieren":"Wechselwunsch abgeben"),1)],8,Ds)])])])],512)])])}}}),Rs=me(Ls,[["__scopeId","data-v-d6fa5f5a"]]);export{Rs as default};
