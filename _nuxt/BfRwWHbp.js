import{e as ae,i as ne,j as ie,g as oe,r as m,k as K,m as de,n as re,c as a,a as s,p as _,d as c,t as o,F as x,s as N,B as Y,q as ce,v as ue,o as n,C as S,M as be,_ as me}from"./BtCKYhO9.js";import{u as ge}from"./BoVQibF0.js";const ve={class:"exchange-page"},he={class:"container py-4"},pe={class:"d-flex justify-content-between align-items-center mb-4"},fe={key:0,class:"text-muted mb-0"},ye={key:0,class:"text-success"},_e={key:1,class:"text-warning"},we={key:2,class:"text-secondary"},ke={class:"badge bg-primary fs-6"},xe={key:0,class:"text-center py-5"},De={class:"card mb-4 shadow-sm"},Ce={class:"card-body p-0"},Ne={class:"table-responsive"},Se={class:"table table-hover mb-0"},Ie={class:"fw-medium"},We={class:"text-end"},Ae=["onClick","disabled"],Ee={key:1,class:"badge bg-secondary"},Le={key:0,class:"card mb-4 shadow-sm"},Re={class:"card-header bg-white d-flex justify-content-between align-items-center"},Fe={class:"badge bg-info"},Pe={class:"card-body p-0"},Te={class:"list-group list-group-flush"},Ue={class:"d-flex justify-content-between align-items-start"},$e={class:"flex-grow-1"},Ke={class:"d-flex align-items-center mb-2"},Ye={class:"fw-medium me-2"},ze={class:"text-primary"},Me={class:"small"},Be={class:"mb-0 ps-3"},Oe={class:"text-end"},je={key:0},Ve=["onClick"],Ge=["onClick"],He={key:1,class:"small text-success"},Ze={key:2,class:"small text-danger"},Xe={class:"modal-dialog modal-lg modal-dialog-scrollable"},Je={class:"modal-content"},Qe={class:"modal-body"},qe={key:0,class:"alert alert-light border mb-4"},es={class:"fw-medium"},ss={class:"badge bg-secondary ms-2"},ts={class:"mb-3"},ls={key:0,class:"text-center text-muted py-4"},as=["onDragstart","onDrop"],ns={class:"badge bg-primary me-2"},is={class:"flex-grow-1"},os={class:"fw-medium"},ds={class:"small text-muted"},rs={class:"text-end me-2"},cs=["onClick"],us={class:"input-group mb-3"},bs={class:"available-courses-list",style:{"max-height":"300px","overflow-y":"auto"}},ms=["draggable","onDragstart"],gs={class:"flex-grow-1"},vs={class:"fw-medium"},hs={class:"small text-muted"},ps={key:0,class:"small text-danger"},fs={key:1,class:"small text-warning"},ys={class:"text-end"},_s=["onClick"],ws={key:1,class:"badge bg-info ms-2"},ks={class:"modal-footer"},xs=["disabled"],Ds={key:0,class:"spinner-border spinner-border-sm me-2"},Cs={key:1,class:"bi bi-check-lg me-1"},Ns=ae({__name:"wechselrunde",setup(Ss){const{$authFetch:h}=ne(),R=ge(),F=ie(),w=oe(),b=m(null),I=m(!0),f=m(null),P=m([]),W=m([]),A=m([]),y=m(null),r=m([]),k=m(""),E=m(!1),D=m(null),T=m(null);let g=null;const z=K(()=>W.value.filter(l=>l.status==="PENDING").length),M=K(()=>{let l=A.value;if(k.value){const e=k.value.toLowerCase();l=l.filter(i=>i.name.toLowerCase().includes(e)||i.blockName.toLowerCase().includes(e))}return l}),L=async()=>{var l;I.value=!0;try{if(!b.value)if(R.currentPeriod)b.value=R.currentPeriod;else{const u=(await h("/periods")).find($=>$.current);u&&(b.value=u)}if(!b.value){console.warn("Keine aktuelle Periode verfügbar"),I.value=!1;return}const e=await h(`/periods/${b.value.id}/exchange-phase`);f.value=e;const i=await h(`/assignments/my?periodId=${b.value.id}`);P.value=i;const t=await h(`/exchange/my-requests?periodId=${b.value.id}`);W.value=t}catch(e){w.show(((l=e==null?void 0:e.data)==null?void 0:l.message)??"Fehler beim Laden der Daten")}finally{I.value=!1}},B=l=>{var e;return!l.preset&&((e=f.value)==null?void 0:e.active)},O=async l=>{var e;if(y.value=l,r.value=[],D.value=null,k.value="",!b.value){w.show("Keine aktuelle Periode verfügbar");return}try{const i=await h(`/exchange/available-courses?periodId=${b.value.id}&assignmentId=${l.id}`);A.value=i}catch(i){w.show(((e=i==null?void 0:i.data)==null?void 0:e.message)??"Fehler beim Laden der verfügbaren Kurse");return}T.value&&!g&&(g=new be(T.value)),g==null||g.show()},j=async l=>{var i,t;const e=P.value.find(d=>d.course.name===l.currentCourseName);if(e){y.value=e,D.value=l,k.value="";try{const d=await h(`/exchange/available-courses?periodId=${(i=b.value)==null?void 0:i.id}&assignmentId=${e.id}`);A.value=d,r.value=l.desiredCourses.map(u=>A.value.find(le=>le.id===u.id)||{id:u.id,courseId:u.courseId,name:u.name,blockName:u.blockName,blockId:0,dayOfWeek:"",availableSpots:0,eligible:!0,ineligibilityReason:null})}catch(d){w.show(((t=d==null?void 0:d.data)==null?void 0:t.message)??"Fehler beim Laden der verfügbaren Kurse");return}g==null||g.show()}},V=async l=>{var e;if(confirm("Möchtest du diesen Wechselwunsch wirklich zurückziehen?"))try{await h(`/exchange/${l.id}`,{method:"DELETE"}),F.success("Wechselwunsch zurückgezogen"),await L()}catch(i){w.show(((e=i==null?void 0:i.data)==null?void 0:e.message)??"Fehler beim Zurückziehen")}},G=l=>{C(l)||r.value.push(l)},H=l=>{r.value.splice(l,1)},C=l=>r.value.some(e=>e.id===l.id);let v=null,p=null;const Z=(l,e)=>{var i;v=e,p=null,(i=l.dataTransfer)==null||i.setData("text/plain",e.id.toString())},X=(l,e)=>{var i;v=r.value[e],p=e,(i=l.dataTransfer)==null||i.setData("text/plain",e.toString())},J=l=>{v&&p===null&&!C(v)&&r.value.push(v),v=null,p=null},Q=(l,e)=>{if(p!==null&&p!==e){const i=r.value.splice(p,1)[0];r.value.splice(e,0,i)}else v&&p===null&&!C(v)&&r.value.splice(e,0,v);v=null,p=null},q=async()=>{var l;if(!(!y.value||r.value.length===0||!b.value)){E.value=!0;try{const e=r.value.map(i=>i.id);D.value?(await h(`/exchange/${D.value.id}`,{method:"PUT",body:{desiredCourseIds:e}}),F.success("Wechselwunsch aktualisiert")):(await h("/exchange",{method:"POST",body:{periodId:b.value.id,currentAssignmentId:y.value.id,desiredCourseIds:e}}),F.success("Wechselwunsch abgegeben")),g==null||g.hide(),await L()}catch(e){w.show(((l=e==null?void 0:e.data)==null?void 0:l.message)??"Fehler beim Absenden des Wechselwunsches")}finally{E.value=!1}}},U=l=>({MONDAY:"Montag",TUESDAY:"Dienstag",WEDNESDAY:"Mittwoch",THURSDAY:"Donnerstag",FRIDAY:"Freitag",SATURDAY:"Samstag",SUNDAY:"Sonntag"})[l]||l,ee=l=>({MONDAY:"bg-primary",TUESDAY:"bg-success",WEDNESDAY:"bg-warning text-dark",THURSDAY:"bg-info",FRIDAY:"bg-danger"})[l]||"bg-secondary",se=l=>({PENDING:"bg-warning text-dark",FULFILLED:"bg-success",UNFULFILLABLE:"bg-danger",EXPIRED:"bg-secondary",WITHDRAWN:"bg-light text-dark"})[l]||"bg-secondary",te=l=>({PENDING:"Offen",FULFILLED:"Erfüllt",UNFULFILLABLE:"Nicht möglich",EXPIRED:"Abgelaufen",WITHDRAWN:"Zurückgezogen"})[l]||l;return de(()=>{L()}),re(()=>R.currentPeriod,()=>{L()}),(l,e)=>{var i;return n(),a("div",ve,[s("div",he,[s("div",pe,[s("div",null,[e[6]||(e[6]=s("h1",{class:"h3 mb-1"},"Kurswechsel",-1)),f.value?(n(),a("p",fe,[f.value.active?(n(),a("span",ye,[e[3]||(e[3]=s("i",{class:"bi bi-circle-fill me-1",style:{"font-size":"0.5rem"}},null,-1)),c(" Wechselphase aktiv bis "+o(f.value.end),1)])):f.value.upcoming?(n(),a("span",_e,[e[4]||(e[4]=s("i",{class:"bi bi-clock me-1"},null,-1)),c(" Startet am "+o(f.value.start),1)])):(n(),a("span",we,e[5]||(e[5]=[s("i",{class:"bi bi-x-circle me-1"},null,-1),c(" Wechselphase beendet ")])))])):_("",!0)]),s("div",null,[s("span",ke,o((i=b.value)==null?void 0:i.name),1)])]),I.value?(n(),a("div",xe,e[7]||(e[7]=[s("div",{class:"spinner-border text-primary",role:"status"},[s("span",{class:"visually-hidden"},"Laden...")],-1),s("p",{class:"mt-3 text-muted"},"Lade Kursdaten...",-1)]))):(n(),a(x,{key:1},[s("div",De,[e[10]||(e[10]=s("div",{class:"card-header bg-white"},[s("h5",{class:"mb-0"},[s("i",{class:"bi bi-journal-bookmark me-2"}),c(" Meine aktuellen Kurse ")])],-1)),s("div",Ce,[s("div",Ne,[s("table",Se,[e[9]||(e[9]=s("thead",{class:"table-light"},[s("tr",null,[s("th",null,"Block"),s("th",null,"Kurs"),s("th",{class:"text-end"},"Aktion")])],-1)),s("tbody",null,[(n(!0),a(x,null,N(P.value,t=>{var d;return n(),a("tr",{key:t.id},[s("td",null,[s("span",{class:S(["badge",ee(t.block.dayOfWeek)])},o(t.block.name),3)]),s("td",Ie,o(t.course.name),1),s("td",We,[B(t)?(n(),a("button",{key:0,class:"btn btn-outline-primary btn-sm",onClick:u=>O(t),disabled:!((d=f.value)!=null&&d.active)},e[8]||(e[8]=[s("i",{class:"bi bi-arrow-left-right me-1"},null,-1),c(" Wechseln ")]),8,Ae)):(n(),a("span",Ee,o(t.preset?"Fest zugewiesen":"Nicht wechselbar"),1))])])}),128))])])])])]),W.value.length>0?(n(),a("div",Le,[s("div",Re,[e[11]||(e[11]=s("h5",{class:"mb-0"},[s("i",{class:"bi bi-hourglass-split me-2"}),c(" Meine Wechselwünsche ")],-1)),s("span",Fe,o(z.value)+" offen",1)]),s("div",Pe,[s("div",Te,[(n(!0),a(x,null,N(W.value,t=>(n(),a("div",{key:t.id,class:"list-group-item"},[s("div",Ue,[s("div",$e,[s("div",Ke,[s("span",Ye,o(t.currentCourseName),1),e[12]||(e[12]=s("i",{class:"bi bi-arrow-right mx-2 text-muted"},null,-1)),s("span",ze,o(t.desiredCourses.length)+" Wunschkurs(e)",1)]),s("div",Me,[s("ol",Be,[(n(!0),a(x,null,N(t.desiredCourses,d=>(n(),a("li",{key:d.id,class:"text-muted"},o(d.name)+" ("+o(d.blockName)+") ",1))),128))])])]),s("div",Oe,[s("span",{class:S(["badge mb-2 d-block",se(t.status)])},o(te(t.status)),3),t.status==="PENDING"?(n(),a("div",je,[s("button",{class:"btn btn-outline-secondary btn-sm me-1",onClick:d=>j(t)},e[13]||(e[13]=[s("i",{class:"bi bi-pencil"},null,-1)]),8,Ve),s("button",{class:"btn btn-outline-danger btn-sm",onClick:d=>V(t)},e[14]||(e[14]=[s("i",{class:"bi bi-x-lg"},null,-1)]),8,Ge)])):t.status==="FULFILLED"?(n(),a("div",He,[e[15]||(e[15]=s("i",{class:"bi bi-check-circle me-1"},null,-1)),c(" "+o(t.fulfilledWithCourseName),1)])):t.rejectionReason?(n(),a("div",Ze,o(t.rejectionReason),1)):_("",!0)])])]))),128))])])])):_("",!0)],64)),s("div",{class:"modal fade",id:"exchangeModal",tabindex:"-1",ref_key:"exchangeModalRef",ref:T},[s("div",Xe,[s("div",Je,[e[27]||(e[27]=s("div",{class:"modal-header"},[s("h5",{class:"modal-title"},[s("i",{class:"bi bi-arrow-left-right me-2"}),c(" Kurs wechseln ")]),s("button",{type:"button",class:"btn-close","data-bs-dismiss":"modal"})],-1)),s("div",Qe,[y.value?(n(),a("div",qe,[e[16]||(e[16]=s("div",{class:"small text-muted mb-1"},"Du gibst ab:",-1)),s("div",es,[c(o(y.value.course.name)+" ",1),s("span",ss,o(y.value.block.name),1)])])):_("",!0),s("div",ts,[e[19]||(e[19]=s("label",{class:"form-label fw-medium"},[s("i",{class:"bi bi-list-ol me-1"}),c(" Wunschliste (nach Priorität geordnet) ")],-1)),e[20]||(e[20]=s("p",{class:"small text-muted"}," Ziehe Kurse in deine Wunschliste. Die Reihenfolge bestimmt die Priorität. ",-1)),s("div",{class:"wishlist-container border rounded p-3 mb-3 bg-light",onDragover:e[1]||(e[1]=Y(()=>{},["prevent"])),onDrop:J},[r.value.length===0?(n(),a("div",ls,e[17]||(e[17]=[s("i",{class:"bi bi-arrow-down-circle fs-3 d-block mb-2"},null,-1),c(" Ziehe gewünschte Kurse hierher ")]))):_("",!0),(n(!0),a(x,null,N(r.value,(t,d)=>(n(),a("div",{key:t.id,class:"wishlist-item d-flex align-items-center bg-white border rounded p-2 mb-2",draggable:"true",onDragstart:u=>X(u,d),onDragover:e[0]||(e[0]=Y(()=>{},["prevent"])),onDrop:u=>Q(u,d)},[s("span",ns,o(d+1),1),s("div",is,[s("div",os,o(t.name),1),s("div",ds,o(t.blockName)+" · "+o(U(t.dayOfWeek)),1)]),s("div",rs,[s("span",{class:S(["badge",t.availableSpots>0?"bg-success":"bg-danger"])},o(t.availableSpots)+" Plätze frei ",3)]),s("button",{class:"btn btn-outline-danger btn-sm",onClick:u=>H(d)},e[18]||(e[18]=[s("i",{class:"bi bi-x"},null,-1)]),8,cs)],40,as))),128))],32)]),s("div",null,[e[25]||(e[25]=s("label",{class:"form-label fw-medium"},[s("i",{class:"bi bi-collection me-1"}),c(" Verfügbare Kurse ")],-1)),s("div",us,[e[21]||(e[21]=s("span",{class:"input-group-text"},[s("i",{class:"bi bi-search"})],-1)),ce(s("input",{type:"text",class:"form-control",placeholder:"Kurse durchsuchen...","onUpdate:modelValue":e[2]||(e[2]=t=>k.value=t)},null,512),[[ue,k.value]])]),s("div",bs,[(n(!0),a(x,null,N(M.value,t=>(n(),a("div",{key:t.id,class:S(["available-course-item d-flex align-items-center border rounded p-2 mb-2",{"border-success":t.eligible&&!t.warning,"border-warning":t.eligible&&t.warning,"border-secondary opacity-50":!t.eligible,"cursor-grab":t.eligible}]),draggable:t.eligible,onDragstart:d=>Z(d,t)},[s("div",gs,[s("div",vs,o(t.name),1),s("div",hs,o(t.blockName)+" · "+o(U(t.dayOfWeek)),1),t.eligible?t.warning?(n(),a("div",fs,[e[23]||(e[23]=s("i",{class:"bi bi-exclamation-triangle me-1"},null,-1)),c(" "+o(t.warning),1)])):_("",!0):(n(),a("div",ps,[e[22]||(e[22]=s("i",{class:"bi bi-exclamation-circle me-1"},null,-1)),c(" "+o(t.ineligibilityReason),1)]))]),s("div",ys,[s("span",{class:S(["badge",t.availableSpots>0?"bg-success":"bg-danger"])},o(t.availableSpots)+" frei ",3),t.eligible&&!C(t)?(n(),a("button",{key:0,class:"btn btn-outline-primary btn-sm ms-2",onClick:d=>G(t)},e[24]||(e[24]=[s("i",{class:"bi bi-plus"},null,-1)]),8,_s)):C(t)?(n(),a("span",ws," In Wunschliste ")):_("",!0)])],42,ms))),128))])])]),s("div",ks,[e[26]||(e[26]=s("button",{type:"button",class:"btn btn-secondary","data-bs-dismiss":"modal"}," Abbrechen ",-1)),s("button",{type:"button",class:"btn btn-primary",disabled:r.value.length===0||E.value,onClick:q},[E.value?(n(),a("span",Ds)):(n(),a("i",Cs)),c(" "+o(D.value?"Aktualisieren":"Wechselwunsch abgeben"),1)],8,xs)])])])],512)])])}}}),As=me(Ns,[["__scopeId","data-v-95ca76b4"]]);export{As as default};
