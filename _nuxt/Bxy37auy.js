import{e as se,i as te,j as le,r as d,k as B,m as ae,n as ne,c as n,a as t,h as a,d as U,p as z,q as m,L as M,I as f,C as S,F as k,s as w,v as Y,t as r,o,_ as oe}from"./CZrh7myW.js";import{w as P}from"./BA3RTNws.js";import{u as re}from"./WFmBwcvg.js";const de={class:"container-fluid py-3"},ie={key:0},ue={class:"card mb-4"},ce={class:"card-body"},me={class:"mb-3"},fe={class:"form-check"},ve={class:"form-check"},pe={key:0,class:"mb-3"},be=["value"],he={key:1,class:"mb-3"},ye=["value"],ge={class:"mb-3"},ke=["value"],we={class:"mb-3"},Ne=["disabled"],_e={key:0,class:"spinner-border spinner-border-sm me-2"},Ae={key:1,class:"bi bi-plus-circle me-2"},xe={class:"card"},Be={class:"card-header bg-secondary text-white d-flex justify-content-between align-items-center"},Se={class:"badge bg-light text-dark"},De={class:"card-body"},Le={key:0,class:"text-center py-4"},Ie={key:1,class:"text-center text-muted py-4"},Ue={key:2},Ee={class:"row mb-3"},Ce={class:"col-md-6"},Te={class:"col-md-3"},ze=["value"],Ve={class:"col-md-3"},Ke=["value"],$e={class:"table-responsive"},Fe={class:"table table-striped table-hover"},Ge={class:"badge bg-info"},Oe={key:0,class:"text-muted"},We={key:1,class:"text-muted fst-italic"},Me={class:"text-muted"},Ye=["onClick","disabled"],Pe={key:0,class:"spinner-border spinner-border-sm"},Re={key:1,class:"bi bi-trash"},je={key:0,class:"text-muted mt-2"},He={key:1,class:"alert alert-warning"},qe=se({__name:"block-ausnahmen",setup(Je){const{$authFetch:v}=te(),c=le(),u=re(),V={MONDAY:0,TUESDAY:1,WEDNESDAY:2,THURSDAY:3,FRIDAY:4,SATURDAY:5,SUNDAY:6},E=d([]),K=d([]),$=d([]),b=d([]),C=d(!1),D=d(!1),L=d(null),i=d("user"),h=d(null),y=d(null),g=d(null),N=d(""),_=d(""),A=d(null),x=d(null),F=B(()=>[...$.value].sort((l,e)=>l-e)),R=B(()=>[...K.value].sort((l,e)=>l.grade!==e.grade?l.grade-e.grade:l.lastName!==e.lastName?l.lastName.localeCompare(e.lastName):l.firstName.localeCompare(e.firstName))),G=B(()=>[...E.value].sort((l,e)=>{const s=V[l.dayOfWeek]??999,p=V[e.dayOfWeek]??999;return s!==p?s-p:l.startTime.localeCompare(e.startTime)})),O=B(()=>g.value?i.value==="user"?h.value!==null:i.value==="grade"?y.value!==null:!1:!1),T=B(()=>{let l=[...b.value];if(_.value){const e=_.value.toLowerCase();l=l.filter(s=>s.firstName.toLowerCase().includes(e)||s.lastName.toLowerCase().includes(e))}return A.value!==null&&(l=l.filter(e=>e.grade===A.value)),x.value!==null&&(l=l.filter(e=>e.blockId===x.value)),l.sort((e,s)=>e.grade!==s.grade?e.grade-s.grade:e.lastName!==s.lastName?e.lastName.localeCompare(s.lastName):e.firstName.localeCompare(s.firstName))}),W=l=>`${P[l.dayOfWeek]||l.dayOfWeek}, ${l.startTime.substring(0,5)} - ${l.endTime.substring(0,5)}`,j=l=>`${(P[l.dayOfWeek]||l.dayOfWeek).substring(0,2)} ${l.startTime.substring(0,5)}`,H=l=>{const e=E.value.find(s=>s.id===l);return e?W(e):`Block ${l}`},q=l=>l?new Date(l).toLocaleDateString("de-DE",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}):"-",J=async()=>{var l;if(u.selectedId)try{E.value=await v("/blocks",{params:{"period-id":u.selectedId}})}catch(e){c.error(((l=e==null?void 0:e.data)==null?void 0:l.message)??"Fehler beim Laden der Blocks")}},Q=async()=>{var l;try{const e=await v("/users");K.value=e.filter(s=>s.ilaMember)}catch(e){c.error(((l=e==null?void 0:e.data)==null?void 0:l.message)??"Fehler beim Laden der Schüler")}},X=async()=>{var l;try{$.value=await v("/users/grades")}catch(e){c.error(((l=e==null?void 0:e.data)==null?void 0:l.message)??"Fehler beim Laden der Klassenstufen")}},I=async()=>{var l;if(u.selectedId){C.value=!0;try{await Promise.all([J(),Q(),X()]),b.value=await v("/block-exclusions",{params:{periodId:u.selectedId}})}catch(e){c.error(((l=e==null?void 0:e.data)==null?void 0:l.message)??"Fehler beim Laden der Ausnahmen")}finally{C.value=!1}}},Z=async()=>{var e;if(!O.value||!u.selectedId)return;const l={blockId:g.value,periodId:u.selectedId,reason:N.value||null};i.value==="user"?l.userName=h.value:l.grade=y.value,D.value=!0;try{const s=await v("/block-exclusions",{method:"POST",body:l});i.value==="user"?c.success("Ausnahme hinzugefügt"):s.added>0?c.success(s.message):c.warning("Alle Schüler hatten bereits diese Ausnahme"),h.value=null,y.value=null,g.value=null,N.value="",await I()}catch(s){c.error(((e=s==null?void 0:s.data)==null?void 0:e.message)??"Fehler beim Hinzufügen der Ausnahme")}finally{D.value=!1}},ee=async l=>{var s;const e=`Ausnahme für ${l.firstName} ${l.lastName} wirklich entfernen?`;if(confirm(e)){L.value=l.id;try{await v(`/block-exclusions/${l.id}`,{method:"DELETE"}),c.success("Ausnahme entfernt"),await I()}catch(p){c.error(((s=p==null?void 0:p.data)==null?void 0:s.message)??"Fehler beim Entfernen der Ausnahme")}finally{L.value=null}}};return ae(async()=>{u.initialized||await u.loadPeriods(v),u.selectedId&&await I()}),ne(()=>u.selectedId,async l=>{l&&await I()}),(l,e)=>(o(),n("div",de,[e[28]||(e[28]=t("div",{class:"d-flex align-items-center justify-content-between mb-3"},[t("div",{class:"h4 m-0"},"Ausnahmen")],-1)),e[29]||(e[29]=t("p",{class:"text-muted"}," Hier können Sie Schüler oder ganze Klassenstufen von bestimmten Blocks ausnehmen (z.B. für Klassenleiterstunden oder andere Verpflichtungen). ",-1)),a(u).selectedId?(o(),n("div",ie,[t("div",ue,[e[20]||(e[20]=t("div",{class:"card-header bg-primary text-white"},[t("h5",{class:"mb-0"},[t("i",{class:"bi bi-plus-circle"}),U(" Neue Ausnahme hinzufügen ")])],-1)),t("div",ce,[t("div",me,[e[11]||(e[11]=t("label",{class:"form-label fw-bold"},"Ausnahme für:",-1)),t("div",fe,[m(t("input",{class:"form-check-input",type:"radio","onUpdate:modelValue":e[0]||(e[0]=s=>f(i)?i.value=s:null),value:"user",id:"typeUser"},null,512),[[M,a(i)]]),e[9]||(e[9]=t("label",{class:"form-check-label",for:"typeUser"}," Einzelner Schüler ",-1))]),t("div",ve,[m(t("input",{class:"form-check-input",type:"radio","onUpdate:modelValue":e[1]||(e[1]=s=>f(i)?i.value=s:null),value:"grade",id:"typeGrade"},null,512),[[M,a(i)]]),e[10]||(e[10]=t("label",{class:"form-check-label",for:"typeGrade"}," Gesamte Klassenstufe ",-1))])]),a(i)==="user"?(o(),n("div",pe,[e[13]||(e[13]=t("label",{class:"form-label fw-bold"},"Schüler:",-1)),m(t("select",{"onUpdate:modelValue":e[2]||(e[2]=s=>f(h)?h.value=s:null),class:"form-select"},[e[12]||(e[12]=t("option",{value:null},"Bitte wählen...",-1)),(o(!0),n(k,null,w(a(R),s=>(o(),n("option",{key:s.userName,value:s.userName},r(s.lastName)+", "+r(s.firstName)+" (Klasse "+r(s.grade)+") ",9,be))),128))],512),[[S,a(h)]])])):z("",!0),a(i)==="grade"?(o(),n("div",he,[e[15]||(e[15]=t("label",{class:"form-label fw-bold"},"Klassenstufe:",-1)),m(t("select",{"onUpdate:modelValue":e[3]||(e[3]=s=>f(y)?y.value=s:null),class:"form-select"},[e[14]||(e[14]=t("option",{value:null},"Bitte wählen...",-1)),(o(!0),n(k,null,w(a(F),s=>(o(),n("option",{key:s,value:s}," Klassenstufe "+r(s),9,ye))),128))],512),[[S,a(y)]])])):z("",!0),t("div",ge,[e[17]||(e[17]=t("label",{class:"form-label fw-bold"},"Block:",-1)),m(t("select",{"onUpdate:modelValue":e[4]||(e[4]=s=>f(g)?g.value=s:null),class:"form-select"},[e[16]||(e[16]=t("option",{value:null},"Bitte wählen...",-1)),(o(!0),n(k,null,w(a(G),s=>(o(),n("option",{key:s.id,value:s.id},r(W(s)),9,ke))),128))],512),[[S,a(g)]])]),t("div",we,[e[18]||(e[18]=t("label",{class:"form-label fw-bold"}," Grund (optional): ",-1)),m(t("input",{"onUpdate:modelValue":e[5]||(e[5]=s=>f(N)?N.value=s:null),type:"text",class:"form-control",placeholder:"z.B. Klassenleiterstunde",maxlength:"512"},null,512),[[Y,a(N)]]),e[19]||(e[19]=t("div",{class:"form-text"}," Dieser Grund wird nur zur internen Dokumentation gespeichert. ",-1))]),t("button",{class:"btn btn-primary",onClick:Z,disabled:!a(O)||a(D)},[a(D)?(o(),n("span",_e)):(o(),n("i",Ae)),U(" "+r(a(i)==="grade"?"Ausnahmen für Klassenstufe hinzufügen":"Ausnahme hinzufügen"),1)],8,Ne)])]),t("div",xe,[t("div",Be,[e[21]||(e[21]=t("h5",{class:"mb-0"},[t("i",{class:"bi bi-list-ul"}),U(" Bestehende Ausnahmen ")],-1)),t("span",Se,r(a(b).length),1)]),t("div",De,[a(C)?(o(),n("div",Le,e[22]||(e[22]=[t("div",{class:"spinner-border text-primary",role:"status"},[t("span",{class:"visually-hidden"},"Lädt...")],-1),t("p",{class:"mt-2 text-muted"},"Lade Ausnahmen...",-1)]))):a(b).length===0?(o(),n("div",Ie,e[23]||(e[23]=[t("i",{class:"bi bi-inbox",style:{"font-size":"3rem"}},null,-1),t("p",{class:"mt-2"},"Noch keine Ausnahmen vorhanden.",-1)]))):(o(),n("div",Ue,[t("div",Ee,[t("div",Ce,[m(t("input",{"onUpdate:modelValue":e[6]||(e[6]=s=>f(_)?_.value=s:null),type:"text",class:"form-control",placeholder:"Nach Name suchen..."},null,512),[[Y,a(_)]])]),t("div",Te,[m(t("select",{"onUpdate:modelValue":e[7]||(e[7]=s=>f(A)?A.value=s:null),class:"form-select"},[e[24]||(e[24]=t("option",{value:null},"Alle Klassenstufen",-1)),(o(!0),n(k,null,w(a(F),s=>(o(),n("option",{key:s,value:s}," Klasse "+r(s),9,ze))),128))],512),[[S,a(A)]])]),t("div",Ve,[m(t("select",{"onUpdate:modelValue":e[8]||(e[8]=s=>f(x)?x.value=s:null),class:"form-select"},[e[25]||(e[25]=t("option",{value:null},"Alle Blocks",-1)),(o(!0),n(k,null,w(a(G),s=>(o(),n("option",{key:s.id,value:s.id},r(j(s)),9,Ke))),128))],512),[[S,a(x)]])])]),t("div",$e,[t("table",Fe,[e[26]||(e[26]=t("thead",{class:"table-light"},[t("tr",null,[t("th",null,"Name"),t("th",null,"Klasse"),t("th",null,"Block"),t("th",null,"Grund"),t("th",null,"Erstellt am"),t("th",{style:{width:"100px"}},"Aktionen")])],-1)),t("tbody",null,[(o(!0),n(k,null,w(a(T),s=>(o(),n("tr",{key:s.id},[t("td",null,r(s.lastName)+", "+r(s.firstName),1),t("td",null,[t("span",Ge,r(s.grade),1)]),t("td",null,r(H(s.blockId)),1),t("td",null,[s.reason?(o(),n("span",Oe,r(s.reason),1)):(o(),n("span",We,"-"))]),t("td",null,[t("small",Me,r(q(s.createdAt)),1)]),t("td",null,[t("button",{class:"btn btn-sm btn-danger",onClick:p=>ee(s),disabled:a(L)===s.id,title:"Ausnahme entfernen"},[a(L)===s.id?(o(),n("span",Pe)):(o(),n("i",Re))],8,Ye)])]))),128))])])]),a(T).length!==a(b).length?(o(),n("div",je,r(a(T).length)+" von "+r(a(b).length)+" Ausnahmen angezeigt ",1)):z("",!0)]))])])])):(o(),n("div",He,e[27]||(e[27]=[t("i",{class:"bi bi-exclamation-triangle"},null,-1),U(" Bitte wählen Sie zunächst eine Period aus. ")])))]))}}),es=oe(qe,[["__scopeId","data-v-6258f89e"]]);export{es as default};
