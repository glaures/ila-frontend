import{e as N,i as R,g as j,j as M,r,m as O,c as l,a as e,d,p as D,t as n,q as B,v as E,h as F,B as A,F as q,s as G,o as a,_ as W}from"./C40gEiOu.js";const H={class:"sticky-top bg-white border-bottom py-2 mb-3",style:{"z-index":"10"}},J={class:"d-flex justify-content-between align-items-center"},Q={class:"d-flex gap-2"},X=["disabled"],Y={key:0,class:"spinner-border spinner-border-sm me-1"},Z={key:1,class:"bi bi-wifi me-1"},ee=["disabled"],se={key:0,class:"spinner-border spinner-border-sm me-1"},te={key:1,class:"bi bi-arrow-repeat me-1"},le={class:"mb-3"},ae={key:0,class:"badge bg-secondary"},ne={key:1,class:"badge bg-success"},ie={key:2,class:"badge bg-danger"},oe={class:"card shadow-sm mb-3"},de={class:"card-body"},re={class:"row g-3 align-items-end"},ce={class:"col-12 col-md-4"},ue=["max"],be={class:"d-flex align-items-center mb-2"},me={class:"row text-center"},ve={class:"col-4"},he={class:"fs-4 fw-bold text-primary"},ge={class:"col-4"},ye={class:"fs-4 fw-bold text-success"},pe={class:"col-4"},_e={key:0,class:"alert alert-warning mt-2 mb-0 py-2"},fe={class:"card shadow-sm mb-3"},we={class:"card-body"},xe={class:"d-flex justify-content-between align-items-center mb-3"},ke=["disabled"],Se={key:0,class:"spinner-border spinner-border-sm"},De={key:1,class:"bi bi-arrow-clockwise"},Ae={class:"row g-3 mb-3"},Te={class:"col-12 col-md-4"},Ce=["max"],Be={class:"col-12 col-md-8 d-flex align-items-end"},Ee={class:"text-muted"},Le={key:0},Ie={key:1},Ve={key:0,class:"text-center py-4"},Fe={key:1,class:"alert alert-info mb-0"},Pe={key:2,class:"table-responsive",style:{"max-height":"400px"}},Ue={class:"table table-sm table-striped table-hover mb-0"},$e={class:"small text-muted"},ze={class:"text-muted small"},Ke={class:"card shadow-sm"},Ne={class:"card-body"},Re={class:"row g-3 align-items-end"},je={class:"col-12 col-md-3"},Me={class:"col-12 col-md-3"},Oe=["disabled"],qe={key:0,class:"spinner-border spinner-border-sm me-1"},Ge={key:1,class:"bi bi-trash me-1"},We={class:"col-12 col-md-6"},He={class:"form-text"},Je={key:0,class:"alert alert-success mt-3 mb-0 py-2"},Qe=N({__name:"beste-schule-abwesenheiten",setup(Xe){const{$authFetch:g}=R(),y=j(),T=M(),p=new Date().toISOString().split("T")[0],v=r(p),_=r(p),f=r(7),u=r(null),h=r(!1),w=r(!1),i=r(null),x=r([]),b=r(!1),k=r(!1),m=r(null);O(async()=>{await L(),await S()});async function L(){var t;try{h.value=!0,u.value=await g("/external-absences/status")}catch(s){y.show(((t=s==null?void 0:s.data)==null?void 0:t.message)??"Fehler beim Prüfen des API-Status"),u.value={available:!1,service:"Beste.Schule API"}}finally{h.value=!1}}async function P(){var t,s;if(v.value)try{w.value=!0,i.value=null,i.value=await g(`/external-absences/sync?date=${v.value}`,{method:"POST"}),(t=i.value)!=null&&t.success?T.success(`${i.value.created} Abwesenheiten synchronisiert`):T.warning("Sync mit Warnungen abgeschlossen"),_.value===v.value&&await S()}catch(c){y.show(((s=c==null?void 0:c.data)==null?void 0:s.message)??"Fehler beim Synchronisieren")}finally{w.value=!1}}async function S(){var t;try{b.value=!0,x.value=await g(`/external-absences?date=${_.value}`)}catch(s){y.show(((t=s==null?void 0:s.data)==null?void 0:t.message)??"Fehler beim Laden der Abwesenheiten")}finally{b.value=!1}}async function U(){var t,s;try{k.value=!0,m.value=null,m.value=await g(`/external-absences/cleanup?daysToKeep=${f.value}`,{method:"DELETE"}),T.success(`${(t=m.value)==null?void 0:t.deletedCount} alte Einträge gelöscht`)}catch(c){y.show(((s=c==null?void 0:c.data)==null?void 0:s.message)??"Fehler beim Bereinigen")}finally{k.value=!1}}function $(t){return new Date(t).toLocaleDateString("de-DE",{weekday:"long",day:"2-digit",month:"2-digit",year:"numeric"})}function C(t){return t?new Date(t).toLocaleString("de-DE",{day:"2-digit",month:"2-digit",hour:"2-digit",minute:"2-digit"}):"-"}function z(t){return t?t.substring(0,8)+"...":"-"}function K(t){switch(t==null?void 0:t.toLowerCase()){case"krank":return"bg-danger";case"freistellung":return"bg-info";case"fehlend":return"bg-warning text-dark";default:return"bg-secondary"}}return(t,s)=>{var c,I,V;return a(),l("div",null,[e("div",H,[e("div",J,[s[5]||(s[5]=e("h4",{class:"mb-0"},[e("i",{class:"bi bi-cloud-download me-2"}),d(" Beste.Schule Abwesenheiten ")],-1)),e("div",Q,[e("button",{class:"btn btn-outline-secondary",onClick:L,disabled:h.value},[h.value?(a(),l("span",Y)):(a(),l("i",Z)),s[3]||(s[3]=d(" Status prüfen "))],8,X),e("button",{class:"btn btn-primary",onClick:P,disabled:w.value||!((c=u.value)!=null&&c.available)},[w.value?(a(),l("span",se)):(a(),l("i",te)),s[4]||(s[4]=d(" Sync starten "))],8,ee)])])]),e("div",le,[h.value?(a(),l("span",ae,s[6]||(s[6]=[e("span",{class:"spinner-border spinner-border-sm me-1",style:{width:"0.7rem",height:"0.7rem"}},null,-1),d(" Prüfe Verbindung... ")]))):(I=u.value)!=null&&I.available?(a(),l("span",ne,[s[7]||(s[7]=e("i",{class:"bi bi-check-circle me-1"},null,-1)),d(" "+n(u.value.service)+" erreichbar ",1)])):u.value!==null?(a(),l("span",ie,[s[8]||(s[8]=e("i",{class:"bi bi-x-circle me-1"},null,-1)),d(" "+n(((V=u.value)==null?void 0:V.service)??"API")+" nicht erreichbar ",1)])):D("",!0)]),e("div",oe,[e("div",de,[s[14]||(s[14]=e("h5",{class:"card-title mb-3"},[e("i",{class:"bi bi-calendar-event me-2"}),d(" Synchronisation ")],-1)),e("div",re,[e("div",ce,[s[9]||(s[9]=e("label",{class:"form-label"},"Datum auswählen",-1)),B(e("input",{type:"date",class:"form-control","onUpdate:modelValue":s[0]||(s[0]=o=>v.value=o),max:F(p)},null,8,ue),[[E,v.value]])]),s[10]||(s[10]=e("div",{class:"col-12 col-md-8"},[e("div",{class:"form-text"}," Abwesenheiten für das gewählte Datum werden von Beste.Schule abgerufen und lokal gespeichert. Der Sync läuft automatisch alle 30 Minuten zwischen 10:00 und 14:00 Uhr. ")],-1))]),i.value?(a(),l("div",{key:0,class:A(["mt-3 p-3 rounded",i.value.success?"bg-success-subtle":"bg-warning-subtle"])},[e("div",be,[e("i",{class:A(["bi me-2",i.value.success?"bi-check-circle text-success":"bi-exclamation-triangle text-warning"])},null,2),e("strong",null,"Sync-Ergebnis für "+n($(i.value.date)),1)]),e("div",me,[e("div",ve,[e("div",he,n(i.value.totalRelevant),1),s[11]||(s[11]=e("small",{class:"text-muted"},"Relevant",-1))]),e("div",ge,[e("div",ye,n(i.value.created),1),s[12]||(s[12]=e("small",{class:"text-muted"},"Importiert",-1))]),e("div",pe,[e("div",{class:A(["fs-4 fw-bold",i.value.errors>0?"text-danger":"text-muted"])},n(i.value.errors),3),s[13]||(s[13]=e("small",{class:"text-muted"},"Fehler",-1))])]),i.value.message?(a(),l("div",_e,n(i.value.message),1)):D("",!0)],2)):D("",!0)])]),e("div",fe,[e("div",we,[e("div",xe,[s[15]||(s[15]=e("h5",{class:"card-title mb-0"},[e("i",{class:"bi bi-list-ul me-2"}),d(" Gespeicherte Abwesenheiten ")],-1)),e("button",{class:"btn btn-sm btn-outline-secondary",onClick:S,disabled:b.value},[b.value?(a(),l("span",Se)):(a(),l("i",De))],8,ke)]),e("div",Ae,[e("div",Te,[s[16]||(s[16]=e("label",{class:"form-label"},"Datum für Anzeige",-1)),B(e("input",{type:"date",class:"form-control","onUpdate:modelValue":s[1]||(s[1]=o=>_.value=o),max:F(p),onChange:S},null,40,Ce),[[E,_.value]])]),e("div",Be,[e("span",Ee,[b.value?(a(),l("span",Le,"Lade...")):(a(),l("span",Ie,n(x.value.length)+" Abwesenheiten gefunden",1))])])]),b.value?(a(),l("div",Ve,s[17]||(s[17]=[e("div",{class:"spinner-border text-primary",role:"status"},null,-1),e("p",{class:"text-muted mt-2 mb-0"},"Lade Abwesenheiten...",-1)]))):x.value.length===0?(a(),l("div",Fe,s[18]||(s[18]=[e("i",{class:"bi bi-info-circle me-2"},null,-1),d(" Keine Abwesenheiten für dieses Datum gespeichert. ")]))):(a(),l("div",Pe,[e("table",Ue,[s[19]||(s[19]=e("thead",{class:"table-light sticky-top"},[e("tr",null,[e("th",null,"Schüler-ID (SaxSVS)"),e("th",null,"Typ"),e("th",null,"Von"),e("th",null,"Bis"),e("th",null,"Importiert")])],-1)),e("tbody",null,[(a(!0),l(q,null,G(x.value,o=>(a(),l("tr",{key:o.id},[e("td",null,[e("code",$e,n(z(o.studentLocalId)),1)]),e("td",null,[e("span",{class:A(["badge",K(o.absenceType)])},n(o.absenceType),3)]),e("td",null,n(C(o.fromDateTime)),1),e("td",null,n(C(o.toDateTime)),1),e("td",ze,n(C(o.fetchedAt)),1)]))),128))])])]))])]),e("div",Ke,[e("div",Ne,[s[23]||(s[23]=e("h5",{class:"card-title mb-3"},[e("i",{class:"bi bi-trash me-2"}),d(" Alte Daten bereinigen ")],-1)),e("div",Re,[e("div",je,[s[20]||(s[20]=e("label",{class:"form-label"},"Tage behalten",-1)),B(e("input",{type:"number",class:"form-control","onUpdate:modelValue":s[2]||(s[2]=o=>f.value=o),min:"1",max:"30"},null,512),[[E,f.value,void 0,{number:!0}]])]),e("div",Me,[e("button",{class:"btn btn-outline-danger",onClick:U,disabled:k.value},[k.value?(a(),l("span",qe)):(a(),l("i",Ge)),s[21]||(s[21]=d(" Bereinigen "))],8,Oe)]),e("div",We,[e("div",He," Löscht alle Abwesenheiten, die älter als "+n(f.value)+" Tage sind. Der Cleanup läuft automatisch täglich um 2:00 Uhr. ",1)])]),m.value?(a(),l("div",Je,[s[22]||(s[22]=e("i",{class:"bi bi-check-circle me-2"},null,-1)),d(" "+n(m.value.deletedCount)+" Einträge gelöscht (älter als "+n(m.value.daysKept)+" Tage) ",1)])):D("",!0)])])])}}}),Ze=W(Qe,[["__scopeId","data-v-ebcc68a9"]]);export{Ze as default};
