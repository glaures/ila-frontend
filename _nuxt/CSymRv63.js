import{e as ne,i as ie,j as oe,g as de,r as m,k as Y,m as re,n as ce,c as a,a as s,p as _,d as c,t as o,F as x,s as C,B as z,q as ue,v as be,o as n,C as N,M as me,_ as ge}from"./DOMMAJn8.js";import{u as ve}from"./DupvfXT0.js";const he={class:"exchange-page"},pe={class:"container py-4"},fe={class:"d-flex justify-content-between align-items-center mb-4"},ye={key:0,class:"text-muted mb-0"},_e={key:0,class:"text-success"},we={key:1,class:"text-warning"},ke={key:2,class:"text-secondary"},xe={class:"badge bg-primary fs-6"},De={key:0,class:"text-center py-5"},Se={class:"card mb-4 shadow-sm"},Ce={class:"card-body p-0"},Ne={class:"table-responsive"},Ie={class:"table table-hover mb-0"},We={class:"fw-medium"},Ee={class:"text-end"},Le=["onClick","disabled"],Ae={key:1,class:"badge bg-secondary"},Re={key:0,class:"card mb-4 shadow-sm"},Fe={class:"card-header bg-white d-flex justify-content-between align-items-center"},Pe={class:"badge bg-info"},Te={class:"card-body p-0"},Ue={class:"list-group list-group-flush"},$e={class:"d-flex justify-content-between align-items-start"},Ke={class:"flex-grow-1"},Ye={class:"d-flex align-items-center mb-2"},ze={class:"fw-medium me-2"},Me={class:"text-primary"},Be={class:"small"},Oe={class:"mb-0 ps-3"},je={class:"text-end"},Ve={key:0},Ge=["onClick"],He=["onClick"],Ze={key:1,class:"small text-success"},Xe={key:2,class:"small text-danger"},Je={class:"modal-dialog modal-lg modal-dialog-scrollable"},Qe={class:"modal-content"},qe={class:"modal-body"},es={key:0,class:"alert alert-light border mb-4"},ss={class:"fw-medium"},ts={class:"badge bg-secondary ms-2"},ls={class:"mb-3"},as={key:0,class:"text-center text-muted py-4"},ns=["onDragstart","onDrop"],is={class:"badge bg-primary me-2"},os={class:"flex-grow-1"},ds={class:"fw-medium"},rs={class:"small text-muted"},cs={class:"text-end me-2"},us=["onClick"],bs={class:"input-group mb-3"},ms={class:"available-courses-list",style:{"max-height":"300px","overflow-y":"auto"}},gs=["draggable","onDragstart"],vs={class:"flex-grow-1"},hs={class:"fw-medium"},ps={class:"small text-muted"},fs={key:0,class:"small text-danger"},ys={key:1,class:"small text-warning"},_s={class:"text-end"},ws=["onClick"],ks={key:1,class:"badge bg-info ms-2"},xs={class:"modal-footer"},Ds=["disabled"],Ss={key:0,class:"spinner-border spinner-border-sm me-2"},Cs={key:1,class:"bi bi-check-lg me-1"},Ns=ne({__name:"wechselrunde",setup(Is){const{$authFetch:h}=ie(),R=ve(),F=oe(),w=de(),b=m(null),I=m(!0),f=m(null),P=m([]),W=m([]),E=m([]),y=m(null),r=m([]),k=m(""),L=m(!1),D=m(null),T=m(null);let g=null;const M=Y(()=>W.value.filter(l=>l.status==="PENDING").length),B=Y(()=>{let l=E.value;if(k.value){const e=k.value.toLowerCase();l=l.filter(i=>i.name.toLowerCase().includes(e)||i.blockName.toLowerCase().includes(e))}return l}),A=async()=>{var l;I.value=!0;try{if(!b.value)if(R.currentPeriod)b.value=R.currentPeriod;else{const u=(await h("/periods")).find(K=>K.current);u&&(b.value=u)}if(!b.value){console.warn("Keine aktuelle Periode verfügbar"),I.value=!1;return}const e=await h(`/periods/${b.value.id}/exchange-phase`);f.value=e;const i=await h(`/assignments/my?periodId=${b.value.id}`);P.value=i;const t=await h(`/exchange/my-requests?periodId=${b.value.id}`);W.value=t}catch(e){w.show(((l=e==null?void 0:e.data)==null?void 0:l.message)??"Fehler beim Laden der Daten")}finally{I.value=!1}},O=l=>{var e;return!l.preset&&((e=f.value)==null?void 0:e.active)},j=async l=>{var e;if(y.value=l,r.value=[],D.value=null,k.value="",!b.value){w.show("Keine aktuelle Periode verfügbar");return}try{const i=await h(`/exchange/available-courses?periodId=${b.value.id}&assignmentId=${l.id}`);E.value=i}catch(i){w.show(((e=i==null?void 0:i.data)==null?void 0:e.message)??"Fehler beim Laden der verfügbaren Kurse");return}T.value&&!g&&(g=new me(T.value)),g==null||g.show()},V=async l=>{var i,t;const e=P.value.find(d=>d.course.name===l.currentCourseName);if(e){y.value=e,D.value=l,k.value="";try{const d=await h(`/exchange/available-courses?periodId=${(i=b.value)==null?void 0:i.id}&assignmentId=${e.id}`);E.value=d,r.value=l.desiredCourses.map(u=>E.value.find(ae=>ae.id===u.id)||{id:u.id,courseId:u.courseId,name:u.name,blockName:u.blockName,blockId:0,dayOfWeek:"",availableSpots:0,eligible:!0,ineligibilityReason:null})}catch(d){w.show(((t=d==null?void 0:d.data)==null?void 0:t.message)??"Fehler beim Laden der verfügbaren Kurse");return}g==null||g.show()}},G=async l=>{var e;if(confirm("Möchtest du diesen Wechselwunsch wirklich zurückziehen?"))try{await h(`/exchange/${l.id}`,{method:"DELETE"}),F.success("Wechselwunsch zurückgezogen"),await A()}catch(i){w.show(((e=i==null?void 0:i.data)==null?void 0:e.message)??"Fehler beim Zurückziehen")}},H=l=>{S(l)||r.value.push(l)},Z=l=>{r.value.splice(l,1)},S=l=>r.value.some(e=>e.id===l.id);let v=null,p=null;const X=(l,e)=>{var i;v=e,p=null,(i=l.dataTransfer)==null||i.setData("text/plain",e.id.toString())},J=(l,e)=>{var i;v=r.value[e],p=e,(i=l.dataTransfer)==null||i.setData("text/plain",e.toString())},Q=l=>{v&&p===null&&!S(v)&&r.value.push(v),v=null,p=null},q=(l,e)=>{if(p!==null&&p!==e){const i=r.value.splice(p,1)[0];r.value.splice(e,0,i)}else v&&p===null&&!S(v)&&r.value.splice(e,0,v);v=null,p=null},ee=async()=>{var l;if(!(!y.value||r.value.length===0||!b.value)){L.value=!0;try{const e=r.value.map(i=>i.id);D.value?(await h(`/exchange/${D.value.id}`,{method:"PUT",body:{desiredCourseIds:e}}),F.success("Wechselwunsch aktualisiert")):(await h("/exchange",{method:"POST",body:{periodId:b.value.id,currentAssignmentId:y.value.id,desiredCourseIds:e}}),F.success("Wechselwunsch abgegeben")),g==null||g.hide(),await A()}catch(e){w.show(((l=e==null?void 0:e.data)==null?void 0:l.message)??"Fehler beim Absenden des Wechselwunsches")}finally{L.value=!1}}},U=l=>new Date(l).toLocaleString("de-DE",{dateStyle:"medium",timeStyle:"short"}),$=l=>({MONDAY:"Montag",TUESDAY:"Dienstag",WEDNESDAY:"Mittwoch",THURSDAY:"Donnerstag",FRIDAY:"Freitag",SATURDAY:"Samstag",SUNDAY:"Sonntag"})[l]||l,se=l=>({MONDAY:"bg-primary",TUESDAY:"bg-success",WEDNESDAY:"bg-warning text-dark",THURSDAY:"bg-info",FRIDAY:"bg-danger"})[l]||"bg-secondary",te=l=>({PENDING:"bg-warning text-dark",FULFILLED:"bg-success",UNFULFILLABLE:"bg-danger",EXPIRED:"bg-secondary",WITHDRAWN:"bg-light text-dark"})[l]||"bg-secondary",le=l=>({PENDING:"Offen",FULFILLED:"Erfüllt",UNFULFILLABLE:"Nicht möglich",EXPIRED:"Abgelaufen",WITHDRAWN:"Zurückgezogen"})[l]||l;return re(()=>{A()}),ce(()=>R.currentPeriod,()=>{A()}),(l,e)=>{var i;return n(),a("div",he,[s("div",pe,[s("div",fe,[s("div",null,[e[6]||(e[6]=s("h1",{class:"h3 mb-1"},"Kurswechsel",-1)),f.value?(n(),a("p",ye,[f.value.active?(n(),a("span",_e,[e[3]||(e[3]=s("i",{class:"bi bi-circle-fill me-1",style:{"font-size":"0.5rem"}},null,-1)),c(" Wechselphase aktiv bis "+o(U(f.value.end)),1)])):f.value.upcoming?(n(),a("span",we,[e[4]||(e[4]=s("i",{class:"bi bi-clock me-1"},null,-1)),c(" Startet am "+o(U(f.value.start)),1)])):(n(),a("span",ke,e[5]||(e[5]=[s("i",{class:"bi bi-x-circle me-1"},null,-1),c(" Wechselphase beendet ")])))])):_("",!0)]),s("div",null,[s("span",xe,o((i=b.value)==null?void 0:i.name),1)])]),I.value?(n(),a("div",De,e[7]||(e[7]=[s("div",{class:"spinner-border text-primary",role:"status"},[s("span",{class:"visually-hidden"},"Laden...")],-1),s("p",{class:"mt-3 text-muted"},"Lade Kursdaten...",-1)]))):(n(),a(x,{key:1},[s("div",Se,[e[10]||(e[10]=s("div",{class:"card-header bg-white"},[s("h5",{class:"mb-0"},[s("i",{class:"bi bi-journal-bookmark me-2"}),c(" Meine aktuellen Kurse ")])],-1)),s("div",Ce,[s("div",Ne,[s("table",Ie,[e[9]||(e[9]=s("thead",{class:"table-light"},[s("tr",null,[s("th",null,"Block"),s("th",null,"Kurs"),s("th",{class:"text-end"},"Aktion")])],-1)),s("tbody",null,[(n(!0),a(x,null,C(P.value,t=>{var d;return n(),a("tr",{key:t.id},[s("td",null,[s("span",{class:N(["badge",se(t.block.dayOfWeek)])},o(t.block.name),3)]),s("td",We,o(t.course.name),1),s("td",Ee,[O(t)?(n(),a("button",{key:0,class:"btn btn-outline-primary btn-sm",onClick:u=>j(t),disabled:!((d=f.value)!=null&&d.active)},e[8]||(e[8]=[s("i",{class:"bi bi-arrow-left-right me-1"},null,-1),c(" Wechseln ")]),8,Le)):(n(),a("span",Ae,o(t.preset?"Fest zugewiesen":"Nicht wechselbar"),1))])])}),128))])])])])]),W.value.length>0?(n(),a("div",Re,[s("div",Fe,[e[11]||(e[11]=s("h5",{class:"mb-0"},[s("i",{class:"bi bi-hourglass-split me-2"}),c(" Meine Wechselwünsche ")],-1)),s("span",Pe,o(M.value)+" offen",1)]),s("div",Te,[s("div",Ue,[(n(!0),a(x,null,C(W.value,t=>(n(),a("div",{key:t.id,class:"list-group-item"},[s("div",$e,[s("div",Ke,[s("div",Ye,[s("span",ze,o(t.currentCourseName),1),e[12]||(e[12]=s("i",{class:"bi bi-arrow-right mx-2 text-muted"},null,-1)),s("span",Me,o(t.desiredCourses.length)+" Wunschkurs(e)",1)]),s("div",Be,[s("ol",Oe,[(n(!0),a(x,null,C(t.desiredCourses,d=>(n(),a("li",{key:d.id,class:"text-muted"},o(d.name)+" ("+o(d.blockName)+") ",1))),128))])])]),s("div",je,[s("span",{class:N(["badge mb-2 d-block",te(t.status)])},o(le(t.status)),3),t.status==="PENDING"?(n(),a("div",Ve,[s("button",{class:"btn btn-outline-secondary btn-sm me-1",onClick:d=>V(t)},e[13]||(e[13]=[s("i",{class:"bi bi-pencil"},null,-1)]),8,Ge),s("button",{class:"btn btn-outline-danger btn-sm",onClick:d=>G(t)},e[14]||(e[14]=[s("i",{class:"bi bi-x-lg"},null,-1)]),8,He)])):t.status==="FULFILLED"?(n(),a("div",Ze,[e[15]||(e[15]=s("i",{class:"bi bi-check-circle me-1"},null,-1)),c(" "+o(t.fulfilledWithCourseName),1)])):t.rejectionReason?(n(),a("div",Xe,o(t.rejectionReason),1)):_("",!0)])])]))),128))])])])):_("",!0)],64)),s("div",{class:"modal fade",id:"exchangeModal",tabindex:"-1",ref_key:"exchangeModalRef",ref:T},[s("div",Je,[s("div",Qe,[e[27]||(e[27]=s("div",{class:"modal-header"},[s("h5",{class:"modal-title"},[s("i",{class:"bi bi-arrow-left-right me-2"}),c(" Kurs wechseln ")]),s("button",{type:"button",class:"btn-close","data-bs-dismiss":"modal"})],-1)),s("div",qe,[y.value?(n(),a("div",es,[e[16]||(e[16]=s("div",{class:"small text-muted mb-1"},"Du gibst ab:",-1)),s("div",ss,[c(o(y.value.course.name)+" ",1),s("span",ts,o(y.value.block.name),1)])])):_("",!0),s("div",ls,[e[19]||(e[19]=s("label",{class:"form-label fw-medium"},[s("i",{class:"bi bi-list-ol me-1"}),c(" Wunschliste (nach Priorität geordnet) ")],-1)),e[20]||(e[20]=s("p",{class:"small text-muted"}," Ziehe Kurse in deine Wunschliste. Die Reihenfolge bestimmt die Priorität. ",-1)),s("div",{class:"wishlist-container border rounded p-3 mb-3 bg-light",onDragover:e[1]||(e[1]=z(()=>{},["prevent"])),onDrop:Q},[r.value.length===0?(n(),a("div",as,e[17]||(e[17]=[s("i",{class:"bi bi-arrow-down-circle fs-3 d-block mb-2"},null,-1),c(" Ziehe gewünschte Kurse hierher ")]))):_("",!0),(n(!0),a(x,null,C(r.value,(t,d)=>(n(),a("div",{key:t.id,class:"wishlist-item d-flex align-items-center bg-white border rounded p-2 mb-2",draggable:"true",onDragstart:u=>J(u,d),onDragover:e[0]||(e[0]=z(()=>{},["prevent"])),onDrop:u=>q(u,d)},[s("span",is,o(d+1),1),s("div",os,[s("div",ds,o(t.name),1),s("div",rs,o(t.blockName)+" · "+o($(t.dayOfWeek)),1)]),s("div",cs,[s("span",{class:N(["badge",t.availableSpots>0?"bg-success":"bg-danger"])},o(t.availableSpots)+" Plätze frei ",3)]),s("button",{class:"btn btn-outline-danger btn-sm",onClick:u=>Z(d)},e[18]||(e[18]=[s("i",{class:"bi bi-x"},null,-1)]),8,us)],40,ns))),128))],32)]),s("div",null,[e[25]||(e[25]=s("label",{class:"form-label fw-medium"},[s("i",{class:"bi bi-collection me-1"}),c(" Verfügbare Kurse ")],-1)),s("div",bs,[e[21]||(e[21]=s("span",{class:"input-group-text"},[s("i",{class:"bi bi-search"})],-1)),ue(s("input",{type:"text",class:"form-control",placeholder:"Kurse durchsuchen...","onUpdate:modelValue":e[2]||(e[2]=t=>k.value=t)},null,512),[[be,k.value]])]),s("div",ms,[(n(!0),a(x,null,C(B.value,t=>(n(),a("div",{key:t.id,class:N(["available-course-item d-flex align-items-center border rounded p-2 mb-2",{"border-success":t.eligible&&!t.warning,"border-warning":t.eligible&&t.warning,"border-secondary opacity-50":!t.eligible,"cursor-grab":t.eligible}]),draggable:t.eligible,onDragstart:d=>X(d,t)},[s("div",vs,[s("div",hs,o(t.name),1),s("div",ps,o(t.blockName)+" · "+o($(t.dayOfWeek)),1),t.eligible?t.warning?(n(),a("div",ys,[e[23]||(e[23]=s("i",{class:"bi bi-exclamation-triangle me-1"},null,-1)),c(" "+o(t.warning),1)])):_("",!0):(n(),a("div",fs,[e[22]||(e[22]=s("i",{class:"bi bi-exclamation-circle me-1"},null,-1)),c(" "+o(t.ineligibilityReason),1)]))]),s("div",_s,[s("span",{class:N(["badge",t.availableSpots>0?"bg-success":"bg-danger"])},o(t.availableSpots)+" frei ",3),t.eligible&&!S(t)?(n(),a("button",{key:0,class:"btn btn-outline-primary btn-sm ms-2",onClick:d=>H(t)},e[24]||(e[24]=[s("i",{class:"bi bi-plus"},null,-1)]),8,ws)):S(t)?(n(),a("span",ks," In Wunschliste ")):_("",!0)])],42,gs))),128))])])]),s("div",xs,[e[26]||(e[26]=s("button",{type:"button",class:"btn btn-secondary","data-bs-dismiss":"modal"}," Abbrechen ",-1)),s("button",{type:"button",class:"btn btn-primary",disabled:r.value.length===0||L.value,onClick:ee},[L.value?(n(),a("span",Ss)):(n(),a("i",Cs)),c(" "+o(D.value?"Aktualisieren":"Wechselwunsch abgeben"),1)],8,Ds)])])])],512)])])}}}),Ls=ge(Ns,[["__scopeId","data-v-900e0dd9"]]);export{Ls as default};
