import{u as T}from"./CXjijLyQ.js";import{e as z,i as G,j,g as O,k as v,r as m,m as V,n as M,c as a,a as s,t as n,d as f,F as W,p as k,C as c,s as R,o as i}from"./C6oO_Yjr.js";const H={class:"container-fluid py-4"},X={class:"d-flex justify-content-between align-items-center mb-4"},K={class:"text-muted mb-0"},Z=["disabled"],J={key:0,class:"spinner-border spinner-border-sm me-2"},Q={key:1,class:"bi bi-play-fill me-1"},Y={key:0,class:"alert alert-warning"},q={class:"row g-3 mb-4"},ss={class:"col-md-3"},es={class:"card h-100 border-0 shadow-sm"},ts={class:"card-body"},ls={class:"d-flex align-items-center"},ns={class:"flex-grow-1 ms-3"},as={class:"mb-0"},is={class:"col-md-3"},os={class:"card h-100 border-0 shadow-sm"},ds={class:"card-body"},cs={class:"d-flex align-items-center"},rs={class:"flex-grow-1 ms-3"},us={class:"mb-0"},hs={class:"col-md-3"},vs={class:"card h-100 border-0 shadow-sm"},ms={class:"card-body"},bs={class:"d-flex align-items-center"},gs={class:"flex-grow-1 ms-3"},fs={class:"mb-0"},_s={class:"col-md-3"},ps={class:"card h-100 border-0 shadow-sm"},xs={class:"card-body"},ys={class:"d-flex align-items-center"},ks={class:"flex-shrink-0"},ws={class:"flex-grow-1 ms-3"},Ls={key:0,class:"text-muted"},Ns={key:0,class:"alert alert-info d-flex align-items-center mb-4"},Es={class:"nav nav-tabs mb-3"},Ws={class:"nav-item"},Ds={class:"badge bg-warning text-dark ms-1"},Is={class:"nav-item"},Fs={class:"card shadow-sm"},Ps={class:"card-body p-0"},Rs={key:0,class:"text-muted p-4"},Cs={key:1,class:"table-responsive"},As={class:"table table-hover mb-0"},Ss={class:"fw-medium"},$s={class:"badge bg-light text-dark ms-1"},Bs={class:"d-flex flex-wrap gap-1"},Us={class:"small text-muted"},Ts={key:0,class:"text-success small"},zs={key:1,class:"text-danger small"},Gs={key:2,class:"text-muted"},js=["onClick"],Os={key:0},Xs=z({__name:"my-assignments",setup(Vs){const{$authFetch:_}=G(),D=T(),I=j(),w=O(),d=v(()=>D.selectedPeriod),r=m([]),b=m("pending"),p=m(!1),L=m(!1),u=m(null),h=m(null),x=v(()=>{var l;return((l=h.value)==null?void 0:l.active)===!0}),N=v(()=>h.value?{start:h.value.start,end:h.value.end,active:h.value.active}:null),g=v(()=>{const l=r.value.filter(t=>t.status==="PENDING").length,e=r.value.filter(t=>t.status==="FULFILLED").length,o=r.value.filter(t=>t.status==="UNFULFILLABLE").length;return{pending:l,fulfilled:e,unfulfillable:o}}),F=v(()=>b.value==="pending"?r.value.filter(l=>l.status==="PENDING"):r.value),C=v(()=>g.value.pending>0),y=async()=>{var l;if(d.value){L.value=!0;try{const[e,o]=await Promise.all([_(`/exchange/admin/all?periodId=${d.value.id}`),_(`/exchange-phase?periodId=${d.value.id}`)]);r.value=e,h.value=o}catch(e){w.show(((l=e==null?void 0:e.data)==null?void 0:l.message)??"Fehler beim Laden der Daten")}finally{L.value=!1}}},A=async()=>{var l;if(d.value&&confirm("Möchtest du die Wechselrunde jetzt auflösen? Dieser Vorgang kann nicht rückgängig gemacht werden.")){p.value=!0;try{const e=await _(`/exchange/admin/resolve?periodId=${d.value.id}`,{method:"POST"});u.value=e,I.success(`${e.fulfilled} von ${e.totalRequests} Wünschen erfüllt`),await y()}catch(e){w.show(((l=e==null?void 0:e.data)==null?void 0:l.message)??"Fehler bei der Auflösung")}finally{p.value=!1}}},S=async(l,e)=>{var o;if(confirm(`Möchtest du den Wechselwunsch von ${e} wirklich löschen?`))try{await _(`/exchange/admin/${l}`,{method:"DELETE"}),I.success("Wechselwunsch wurde gelöscht"),await y()}catch(t){w.show(((o=t==null?void 0:t.data)==null?void 0:o.message)??"Fehler beim Löschen des Wechselwunsches")}},$=l=>l?new Date(l).toLocaleString("de-DE",{dateStyle:"short",timeStyle:"short"}):"—",B=l=>({PENDING:"bg-warning text-dark",FULFILLED:"bg-success",UNFULFILLABLE:"bg-danger",EXPIRED:"bg-secondary",WITHDRAWN:"bg-light text-dark border"})[l]||"bg-secondary",U=l=>({PENDING:"Offen",FULFILLED:"Erfüllt",UNFULFILLABLE:"Nicht möglich",EXPIRED:"Abgelaufen",WITHDRAWN:"Zurückgezogen"})[l]||l;return V(()=>{y()}),M(()=>{var l;return(l=D.selectedPeriod)==null?void 0:l.id},()=>{y()}),(l,e)=>{var o;return i(),a("div",H,[s("div",X,[s("div",null,[e[2]||(e[2]=s("h1",{class:"h3 mb-1"},"Wechselrunde verwalten",-1)),s("p",K,n((o=d.value)==null?void 0:o.name),1)]),s("div",null,[s("button",{class:"btn btn-success",disabled:!C.value||p.value,onClick:A},[p.value?(i(),a("span",J)):(i(),a("i",Q)),e[3]||(e[3]=f(" Auflösung starten "))],8,Z)])]),d.value?(i(),a(W,{key:1},[s("div",q,[s("div",ss,[s("div",es,[s("div",ts,[s("div",ls,[e[5]||(e[5]=s("div",{class:"flex-shrink-0"},[s("div",{class:"bg-primary bg-opacity-10 rounded-circle p-3"},[s("i",{class:"bi bi-hourglass-split text-primary fs-4"})])],-1)),s("div",ns,[e[4]||(e[4]=s("h6",{class:"text-muted mb-1"},"Offene Wünsche",-1)),s("h3",as,n(g.value.pending),1)])])])])]),s("div",is,[s("div",os,[s("div",ds,[s("div",cs,[e[7]||(e[7]=s("div",{class:"flex-shrink-0"},[s("div",{class:"bg-success bg-opacity-10 rounded-circle p-3"},[s("i",{class:"bi bi-check-circle text-success fs-4"})])],-1)),s("div",rs,[e[6]||(e[6]=s("h6",{class:"text-muted mb-1"},"Erfüllt",-1)),s("h3",us,n(g.value.fulfilled),1)])])])])]),s("div",hs,[s("div",vs,[s("div",ms,[s("div",bs,[e[9]||(e[9]=s("div",{class:"flex-shrink-0"},[s("div",{class:"bg-danger bg-opacity-10 rounded-circle p-3"},[s("i",{class:"bi bi-x-circle text-danger fs-4"})])],-1)),s("div",gs,[e[8]||(e[8]=s("h6",{class:"text-muted mb-1"},"Nicht erfüllbar",-1)),s("h3",fs,n(g.value.unfulfillable),1)])])])])]),s("div",_s,[s("div",ps,[s("div",xs,[s("div",ys,[s("div",ks,[s("div",{class:c(["rounded-circle p-3",x.value?"bg-success bg-opacity-10":"bg-secondary bg-opacity-10"])},[s("i",{class:c(["fs-4",x.value?"bi bi-broadcast text-success":"bi bi-broadcast text-secondary"])},null,2)],2)]),s("div",ws,[e[10]||(e[10]=s("h6",{class:"text-muted mb-1"},"Phase",-1)),s("h5",{class:c(["mb-0",x.value?"text-success":"text-secondary"])},n(x.value?"Aktiv":"Inaktiv"),3),N.value?(i(),a("small",Ls,n(N.value.start)+" – "+n(N.value.end),1)):k("",!0)])])])])])]),u.value?(i(),a("div",Ns,[e[12]||(e[12]=s("i",{class:"bi bi-info-circle me-2"},null,-1)),s("div",null,[e[11]||(e[11]=s("strong",null,"Letzte Auflösung:",-1)),f(" "+n(u.value.fulfilled)+" von "+n(u.value.totalRequests)+" Wünschen erfüllt ("+n(u.value.fulfillmentRate.toFixed(1))+"%) in "+n(u.value.rounds)+" Runden ",1)])])):k("",!0),s("ul",Es,[s("li",Ws,[s("button",{class:c(["nav-link",{active:b.value==="pending"}]),onClick:e[0]||(e[0]=t=>b.value="pending")},[e[13]||(e[13]=f(" Offene Wünsche ")),s("span",Ds,n(g.value.pending),1)],2)]),s("li",Is,[s("button",{class:c(["nav-link",{active:b.value==="all"}]),onClick:e[1]||(e[1]=t=>b.value="all")}," Alle Wünsche ",2)])]),s("div",Fs,[s("div",Ps,[L.value?(i(),a("div",Rs,"Lade Wechselwünsche…")):(i(),a("div",Cs,[s("table",As,[e[17]||(e[17]=s("thead",{class:"table-light"},[s("tr",null,[s("th",null,"Schüler"),s("th",null,"Gibt ab"),s("th",null,"Wunschliste"),s("th",null,"Status"),s("th",null,"Erstellt"),s("th",null,"Ergebnis"),s("th",null,"Aktionen")])],-1)),s("tbody",null,[(i(!0),a(W,null,R(F.value,t=>(i(),a("tr",{key:t.id},[s("td",Ss,n(t.studentName),1),s("td",null,[f(n(t.currentCourseName)+" ",1),s("span",$s,n(t.currentBlockName),1)]),s("td",null,[s("div",Bs,[(i(!0),a(W,null,R(t.desiredCourses,(E,P)=>(i(),a("span",{key:E.id,class:c(["badge",P===0?"bg-primary":"bg-secondary"])},n(P+1)+". "+n(E.name),3))),128))])]),s("td",null,[s("span",{class:c(["badge",B(t.status)])},n(U(t.status)),3)]),s("td",Us,n($(t.createdAt)),1),s("td",null,[t.fulfilledWithCourseName?(i(),a("span",Ts,[e[14]||(e[14]=s("i",{class:"bi bi-check me-1"},null,-1)),f(" "+n(t.fulfilledWithCourseName),1)])):t.rejectionReason?(i(),a("span",zs,n(t.rejectionReason),1)):(i(),a("span",Gs,"—"))]),s("td",null,[t.status==="PENDING"?(i(),a("button",{key:0,class:"btn btn-sm btn-outline-danger",onClick:E=>S(t.id,t.studentName),title:"Wechselwunsch löschen"},e[15]||(e[15]=[s("i",{class:"bi bi-trash"},null,-1)]),8,js)):k("",!0)])]))),128)),F.value.length===0?(i(),a("tr",Os,e[16]||(e[16]=[s("td",{colspan:"7",class:"text-center text-muted py-4"}," Keine Wechselwünsche vorhanden ",-1)]))):k("",!0)])])]))])])],64)):(i(),a("div",Y," Bitte wähle zuerst eine Phase, um die Wechselrunde zu verwalten. "))])}}});export{Xs as default};
